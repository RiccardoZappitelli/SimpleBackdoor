<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Remote UI — Terminal + Controls</title>
<style>
  :root{
    --bg:#0b0f14;
    --panel:#0f1720;
    --muted:#9aa6b2;
    --accent:#4fd1c5;
    --danger:#ff5c57;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{
    background: linear-gradient(180deg,#061018 0%, #07121a 100%);
    color:#e6eef3;
    padding:16px;
    box-sizing:border-box;
  }
  .app{height:calc(100vh - 32px);display:flex;gap:16px}
  .terminal-wrap{
    flex:1 1 60%;
    background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    border-radius:12px;
    padding:12px;
    display:flex;
    flex-direction:column;
    box-shadow:0 6px 18px rgba(2,6,12,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  .term-header{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;color:var(--muted)}
  .circles{display:flex;gap:6px}
  .c{width:12px;height:12px;border-radius:50%}
  .c.r{background:#ff6157}.c.y{background:#ffbd2e}.c.g{background:#48d557}
  .terminal{
    margin-top:8px;background:#02040a;border-radius:8px;padding:12px;flex:1 1 auto;overflow:auto;
    font-family:"Source Code Pro",ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;
    font-size:13px;line-height:1.4;color:#d6e7f0;box-shadow:inset 0 2px 6px rgba(0,0,0,0.7);
    border:1px solid rgba(255,255,255,0.02)
  }
  .term-input{display:flex;gap:8px;margin-top:8px}
  .term-input input[type="text"]{
    flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);
    background:transparent;color:inherit;font-family:inherit
  }
  .btn{background:var(--accent);border:0;padding:8px 12px;border-radius:8px;color:#042022;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:500}
  .small{padding:6px 8px;font-size:13px}
  .controls{flex:0 0 380px;display:flex;flex-direction:column;gap:12px;min-width:260px}
  .card{
    background:var(--panel);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.02);
    box-shadow:0 4px 10px rgba(2,6,12,0.6)
  }
  h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
  .mouse-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-items:center;justify-items:center}
  .arrow{
    width:56px;height:56px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);
    display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--glass);user-select:none
  }
  .mouse-buttons{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .mouse-buttons .arrow{width:110px}
  .kbd{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto;padding-right:6px}
  .kbd-row{display:flex;gap:6px;justify-content:center}
  .key{
    padding:8px 10px;border-radius:6px;min-width:34px;text-align:center;background:transparent;
    border:1px solid rgba(255,255,255,0.03);cursor:pointer;user-select:none
  }
  .key.wide{min-width:70px}.key.space{min-width:260px}.key:active{transform:translateY(1px)}
  .upload-area{
    border:2px dashed rgba(255,255,255,0.03);padding:10px;border-radius:8px;text-align:center;font-size:13px;color:var(--muted)
  }
  .files-list{margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto}
  .file-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:rgba(255,255,255,0.02)}
  .file-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:190px}
  .file-actions{display:flex;gap:6px}
  footer.note{margin-top:8px;font-size:12px;color:var(--muted)}
  @media (max-width:900px){
    .app{flex-direction:column}.controls{flex-basis:auto;width:100%}.terminal-wrap{flex-basis:auto;width:100%}.key.space{min-width:120px}
  }
    /* Toggle button styles */
  #toggleScreenBtn {
    transition: all 0.2s ease;
    border-radius: 8px;
    font-weight: 600;
    padding: 8px 14px;
  }

  #toggleScreenBtn.active {
    background: #ff6157;
    color: #fff;
    border-color: #ff6157;
  }

  #toggleScreenBtn:hover {
    filter: brightness(1.1);
  }
</style>
</head>
<body>
<div class="app">
  <section class="terminal-wrap card">
    <div class="term-header">
      <div class="circles"><div class="c r"></div><div class="c y"></div><div class="c g"></div></div>
      <div style="margin-left:8px">
        <strong>Remote Terminal</strong>
        <small style="color:var(--muted)">Flask-connected interface</small>
      </div>
    </div>
    <input id="toggleScreenBtn" type="button" value="Show Screen" class="btn" />
    <div id="terminal" class="terminal">
      <div><span style="color:var(--accent)">&gt;</span> Welcome. Terminal ready.</div>
    </div>
    <div class="term-input">
      <input id="cmd" type="text" placeholder="Enter command..." autocomplete="off" />
      <button id="sendCmd" class="btn small">Send</button>
      <button id="clearTerm" class="btn ghost small">Clear</button>
    </div>
  </section>

  <aside class="controls">
    <div class="card">
      <h3>Mouse control</h3>
      <div class="mouse-grid">
        <div></div><div class="arrow" data-mouse="up">↑</div><div></div>
        <div class="arrow" data-mouse="left">←</div><div style="font-size:12px;color:var(--muted)">Move</div><div class="arrow" data-mouse="right">→</div>
        <div></div><div class="arrow" data-mouse="down">↓</div><div></div>
      </div>
      <div class="mouse-buttons">
        <div class="arrow" data-mouse="leftclick">Left Click</div>
        <div class="arrow" data-mouse="rightclick">Right Click</div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <input id="mouseStep" type="number" value="10" min="1" step="1" style="width:84px;padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit" />
        <label style="align-self:center;color:var(--muted)">px step</label>
      </div>
    </div>

    <div class="card">
      <h3>On-screen keyboard</h3>
      <div class="kbd" id="keyboard"></div>
    </div>

    <div class="card">
      <h3>Upload & File Explorer</h3>
      <div id="uploadArea" class="upload-area" tabindex="0">
        Drop files here or
        <label style="color:var(--accent);cursor:pointer">
          <input id="fileInput" type="file" multiple style="display:none" />
          <span>choose files</span>
        </label>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="uploadBtn" class="btn small">Upload selected</button>
        <button id="refreshBtn" class="btn ghost small">Refresh list</button>
      </div>
      <div class="files-list" id="filesList"></div>
    </div>
    <div class="card">
      <h3>Plugins</h3>
      <div style="margin-bottom:8px;display:flex;gap:8px">
      <button id="refreshPlugins" class="btn small">Refresh</button>
      </div>
    <div id="pluginsList" class="files-list"></div>
    </div>
  </aside>
</div>

<script>
const terminal=document.getElementById('terminal');
const cmdInput=document.getElementById('cmd');
const sendCmd=document.getElementById('sendCmd');
const clearTerm=document.getElementById('clearTerm');
const showScreenButton=document.getElementById("showScreenButton")
const toggleBtn = document.getElementById("toggleScreenBtn");
let screenShown = false;
let streamEl;

toggleBtn.addEventListener("click", () => {
  screenShown = !screenShown;

  const terminalWrap = document.querySelector(".terminal-wrap");
  const termInput = document.querySelector(".term-input");
  const terminalArea = document.getElementById("terminal");

  if (screenShown) {
    // Remove terminal area
    terminalArea.style.display = "none";

    // Create stream element
    streamEl = document.createElement("img"); // MJPEG works with <img>
    streamEl.id = "liveScreen";
    streamEl.src = "/screen_stream";
    streamEl.style.width = "100%";
    streamEl.style.height = "calc(100% - 48px)"; // leave space for input
    streamEl.style.borderRadius = "8px";
    streamEl.style.backgroundColor = "#000";
    streamEl.style.marginTop = "8px";

    // Insert above the input
    terminalWrap.insertBefore(streamEl, termInput);

    toggleBtn.value = "Hide Screen";
    toggleBtn.classList.add("active");

  } else {
    // Remove stream
    if (streamEl) streamEl.remove();

    // Show terminal area again
    terminalArea.style.display = "block";

    toggleBtn.value = "Show Screen";
    toggleBtn.classList.remove("active");
  }
});

function termAppend(html){const d=document.createElement('div');d.innerHTML=html;terminal.appendChild(d);terminal.scrollTop=terminal.scrollHeight;}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

function sendCommand(cmd){
  if(!cmd)return;
  termAppend(`<span style="color:var(--accent)">&gt;</span> ${escapeHtml(cmd)}`);

  fetch('/terminal', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({cmd})
  })
  .then(async r => {
    const contentType = r.headers.get("content-type");
    if(contentType && contentType.includes("application/json")) {
      const data = await r.json();
      if(data.download_url){
        window.open(data.download_url, "_blank"); // opens in new tab
        termAppend(`<small style="color:var(--accent)">Download started in a new tab.</small>`);
        return;
      }
    }
    const text = await r.text();
    termAppend('<pre>'+escapeHtml(text)+'</pre>');
  })
  .catch(()=>termAppend('<pre style="color:var(--danger)">[error]</pre>'));
}


sendCmd.onclick=()=>{sendCommand(cmdInput.value);cmdInput.value='';};
cmdInput.addEventListener('keydown',e=>{if(e.key==='Enter'){sendCommand(cmdInput.value);cmdInput.value='';}});
clearTerm.onclick=()=>{terminal.innerHTML='';termAppend('<div><span style="color:var(--accent)">&gt;</span> Terminal cleared.</div>');};

document.querySelectorAll('[data-mouse]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const action=btn.dataset.mouse;
    const step=Number(document.getElementById('mouseStep').value)||10;
    termAppend(`<small style="color:${action.includes('click')?'var(--muted)':'var(--accent)'}">mouse → ${action} (${step})</small>`);
    fetch('/mouse',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,step})});
  });
});

function handleKeySent(key){
  termAppend(`<small style="color:var(--muted)">key → ${escapeHtml(key)}</small>`);
  fetch('/key',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key})});
}

const pluginsList=document.getElementById('pluginsList');
const refreshPlugins=document.getElementById('refreshPlugins');

async function loadPlugins(){
  const res=await fetch('/plugins');
  const data=await res.json();
  pluginsList.innerHTML='';
  if(!data.length){
    pluginsList.innerHTML='<div style="color:var(--muted);padding:8px">No plugins found.</div>';
    return;
  }
  data.forEach(p=>{
    const el=document.createElement('div');
    el.className='file-item';
    el.innerHTML=`<div class="file-name">${escapeHtml(p.name)}</div>
    <div class="file-actions"><button class="btn small">Run</button></div>`;
    pluginsList.appendChild(el);
    el.querySelector('button').onclick=()=>runPlugin(p.name);
  });
}

async function runPlugin(name){
  termAppend(`<small style="color:var(--muted)">Running plugin: ${escapeHtml(name)}</small>`);
  const res = await fetch('/plugins/' + encodeURIComponent(name), { method: 'POST' });
  const text = await res.text();

  if (text.trimStart().startsWith("js:")) {
    const jsCode = text.slice(3);
    try {
      new Function(jsCode)(); // executes the plugin’s JS
      termAppend('<small style="color:var(--accent)">Plugin executed JavaScript.</small>');
    } catch (err) {
      termAppend('<pre style="color:var(--danger)">JS Error: ' + escapeHtml(err.message) + '</pre>');
    }
  } else {
    termAppend('<pre>' + escapeHtml(text) + '</pre>');
  }
}


refreshPlugins.onclick=loadPlugins;
loadPlugins();
runPlugin("autorun.py");


const kbd = document.getElementById('keyboard');
const layout = [
  "` 1 2 3 4 5 6 7 8 9 0 - = Backspace",
  "Tab Q W E R T Y U I O P [ ] \\",
  "Caps A S D F G H J K L ; ' Enter",
  "Shift Z X C V B N M , . / Shift",
  "Ctrl Alt Gui Space Gui Alt Ctrl"
];

function handleKeySent(key) {
  termAppend(`<small style="color:var(--muted)">key → ${escapeHtml(key)}</small>`);
  fetch('/key', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ key })
  });
}

layout.forEach(row => {
  const rowEl = document.createElement('div');
  rowEl.className = 'kbd-row';
  row.split(' ').forEach(k => {
    const el = document.createElement('div');
    el.className = 'key';
    if (['Backspace','Tab','Caps','Enter','Shift','Ctrl','Alt','Gui','Space'].includes(k)) el.classList.add('wide');
    if (k === 'Space') el.classList.add('space');
    el.textContent = k;
    el.onclick = () => handleKeySent(k);
    rowEl.appendChild(el);
  });
  kbd.appendChild(rowEl);
});

const fileInput=document.getElementById('fileInput');
const uploadBtn=document.getElementById('uploadBtn');
const refreshBtn=document.getElementById('refreshBtn');
const filesList=document.getElementById('filesList');
let selectedFiles=[];

fileInput.onchange=e=>{selectedFiles=Array.from(e.target.files);showSelectedFiles();};
function showSelectedFiles(){
  filesList.innerHTML='';
  if(!selectedFiles.length){filesList.innerHTML='<div style="color:var(--muted);padding:8px">No files selected.</div>';return;}
  selectedFiles.forEach(f=>{
    const el=document.createElement('div');
    el.className='file-item';
    el.innerHTML=`<div class="file-name">${escapeHtml(f.name)}</div><div class="file-actions"><button class="btn small">Upload</button></div>`;
    filesList.appendChild(el);
    el.querySelector('button').onclick=()=>uploadSingle(f);
  });
}

async function uploadSingle(file){
  termAppend(`<small style="color:var(--muted)">Uploading ${escapeHtml(file.name)} ...</small>`);
  const fd=new FormData();fd.append('file',file);
  const res=await fetch('/upload',{method:'POST',body:fd});
  if(res.ok)termAppend(`<small style="color:var(--accent)">${escapeHtml(file.name)} uploaded</small>`);
  else termAppend(`<small style="color:var(--danger)">Upload failed</small>`);
  loadFiles();
}

async function loadFiles(){
  const res=await fetch('/files');
  const data=await res.json();
  filesList.innerHTML='';
  if(!data.length){filesList.innerHTML='<div style="color:var(--muted);padding:8px">No files found.</div>';return;}
  data.forEach(f=>{
    const el=document.createElement('div');
    el.className='file-item';
    el.innerHTML=`<div class="file-name">${escapeHtml(f.name)}</div>
      <div class="file-actions">
        <a class="btn small" href="/files/${encodeURIComponent(f.name)}??from_upload_dir=true" download="${escapeHtml(f.name)}">Download</a>
        <button class="btn ghost small">Delete</button>
      </div>`;
    filesList.appendChild(el);
    el.querySelector('button').onclick=async()=>{
      await fetch('/files/'+encodeURIComponent(f.name),{method:'DELETE'});
      loadFiles();
    };
  });
}

uploadBtn.onclick=()=>{
  if(!selectedFiles.length){termAppend('<small style="color:var(--muted)">No files selected to upload.</small>');return;}
  selectedFiles.forEach(f=>uploadSingle(f));
  selectedFiles=[];
  fileInput.value='';
};

refreshBtn.onclick=loadFiles;
loadFiles();
</script>
</body>
</html>
